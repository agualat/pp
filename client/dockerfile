FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive \
	PYTHONDONTWRITEBYTECODE=1 \
	PYTHONUNBUFFERED=1 \
	PIP_NO_CACHE_DIR=1

WORKDIR /app

# Create data directory for server configurations
RUN mkdir -p /app/client_data && chmod 755 /app/client_data

# Install system deps, Python, pip, NSS/PAM packages, cron
RUN apt-get update -y \
    && apt-get install -y --no-install-recommends \
       python3 python3-pip python3-dev \
       build-essential \
       libnss-pgsql2 libpam-pgsql gettext-base \
       cron postgresql-client \
    && ln -sf /usr/bin/python3 /usr/bin/python \
    && ln -sf /usr/bin/pip3 /usr/bin/pip \
    && rm -rf /var/lib/apt/lists/*# Install Python requirements
COPY client/requirements.txt client/requirements.txt
RUN pip install --no-cache-dir -r client/requirements.txt

# Copy application code
COPY client /app/client
RUN chmod +x /app/client/utils/setup_nss_pam.sh || true

# Entrypoint script
COPY client/entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

EXPOSE 8100

# NSS/PAM DB envs (optional)
ENV DB_HOST= \
	DB_PORT= \
	DB_NAME= \
	NSS_DB_USER= \
	NSS_DB_PASSWORD=

ENTRYPOINT ["/app/entrypoint.sh"]
